# 背景信息

```bash
[root@localhost P2P]# lspci -tv
-[0000:00]-+-00.0  Loongson Technology LLC Device 7a59
           +-04.0  Loongson Technology LLC OHCI USB Controller
           +-04.1  Loongson Technology LLC EHCI USB Controller
           +-05.0  Loongson Technology LLC OHCI USB Controller
           +-05.1  Loongson Technology LLC EHCI USB Controller
           +-07.0  Loongson Technology LLC HDA (High Definition Audio) Controller
           +-08.0  Loongson Technology LLC Device 7a18
           +-09.0-[03]--
           +-0a.0-[04]----00.0  Loongson Technology LLC Device 1a05
           +-0b.0-[05]----00.0  Device 1f0a:6801
           +-0c.0-[06]----00.0  Device 1f0a:6801
           +-0d.0-[07]--
           +-0f.0-[08]--
           +-10.0-[09]--
           +-16.0  Loongson Technology LLC Device 7a1b
           +-19.0  Loongson Technology LLC Device 7a34
           +-1c.0-[0a-0c]--+-00.0-[0b]----00.0  Device 2006:0100
           |               \-01.0-[0c]--
           +-1d.0  Loongson Technology LLC Device 3c0f
           \-1e.0-[0d-11]--+-00.0-[0e]--
                           +-01.0-[0f]----00.0  Device 2006:0100
                           +-02.0-[10]--
                           +-03.0-[11]----00.0  YEESTOR Microelectronics Co., Ltd Device ef25
                           \-04.0  Loongson Technology LLC Device 3c0f
[root@localhost P2P]#

```
## 信息解析
---

PCIe 地址结构解析
0000:00 的含义
PCIe 设备地址格式为：Domain:Bus:Device.Function
0000:00:1e.0
│    │  │  └─ Function (功能号): 0-7
│    │  └──── Device (设备号): 0-31  
│    └─────── Bus (总线号): 0-255
└──────────── Domain (域): 0-65535
0000:00 表示：

Domain 0000: PCIe 域 0（大多数系统只有一个域）
Bus 00: 总线 0（Root Complex 所在的主总线）

Root Complex (RC) 始终位于 Domain:0, Bus:0，即 0000:00
域（Domain）的作用

单域系统：大多数系统只有 Domain 0
多域系统：多 CPU、多 Root Complex 系统可能有多个域

例如：0000:00, 0001:00 表示两个独立的 PCIe 域


你的系统：只有一个域 (0000)，所有设备都在 Domain 0


0f:00.0 完整 PCIe 链路图
图形化表示
┌─────────────────────────────────────────────────────────────────────────┐
│                         Root Complex (RC)                                │
│                       Domain: 0000, Bus: 00                              │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                        ┌───────────┴───────────┐
                        │   0000:00:1e.0        │  ← Root Port
                        │   PCI Bridge [0604]   │
                        │   Loongson 3c09       │
                        └───────────┬───────────┘
                                    │
                        ┌───────────▼───────────┐
                        │    PCIe Link          │
                        │    Bus 0d (13)        │  ← Secondary Bus
                        └───────────┬───────────┘
                                    │
                        ┌───────────▼───────────┐
                        │   0000:0d:01.0        │  ← PCIe Switch
                        │   PCI Bridge [0604]   │     Downstream Port
                        │   Loongson 3c19       │
                        └───────────┬───────────┘
                                    │
                        ┌───────────▼───────────┐
                        │    PCIe Link          │
                        │    Bus 0f (15)        │  ← Tertiary Bus
                        └───────────┬───────────┘
                                    │
                        ┌───────────▼───────────┐
                        │   0000:0f:00.0        │  ← 加速卡 (终端设备)
                        │   Device 2006:0100    │
                        │   Processing accel.   │
                        └───────────────────────┘
层次结构文本表示
层级 0 (Root Complex):
    ├─ 0000:00:1e.0 - PCI Bridge [0604] - Root Port
    │   └─ Primary Bus: 00
    │   └─ Secondary Bus: 0d (13)
    │   └─ Subordinate Bus: 11 (17)
    │
层级 1 (PCIe Switch):
    ├─ 0000:0d:01.0 - PCI Bridge [0604] - Switch Downstream Port
    │   └─ Primary Bus: 0d (13)
    │   └─ Secondary Bus: 0f (15)
    │   └─ Subordinate Bus: 0f (15)
    │
层级 2 (End Device):
    └─ 0000:0f:00.0 - Device 2006:0100 - 加速卡
        └─ Bus: 0f (15)
        └─ Device: 00
        └─ Function: 0
详细的总线编号说明
总线号 (十六进制)总线号 (十进制)说明000Root Complex 主总线0d13PCIe Switch 上游总线0f15加速卡所在总线

完整的 PCIe 配置空间信息
查看完整链路的命令
bash# 1. 查看 Root Port (00:1e.0)
lspci -vvv -s 0000:00:1e.0 | grep -E "Bus:|LnkCap|LnkSta"

# 2. 查看 PCIe Switch (0d:01.0)
lspci -vvv -s 0000:0d:01.0 | grep -E "Bus:|LnkCap|LnkSta"

# 3. 查看加速卡 (0f:00.0)
lspci -vvv -s 0000:0f:00.0 | grep -E "Bus:|LnkCap|LnkSta"
预期输出示例
bash# Root Port
Bus: primary=00, secondary=0d, subordinate=11
LnkCap: Speed 16GT/s, Width x16
LnkSta: Speed 16GT/s, Width x16

# PCIe Switch Downstream Port
Bus: primary=0d, secondary=0f, subordinate=0f
LnkCap: Speed 16GT/s, Width x16
LnkSta: Speed 16GT/s, Width x16

# 加速卡
LnkCap: Speed 16GT/s, Width x16
LnkSta: Speed 16GT/s, Width x16

完整的链路分析脚本
创建 analyze_pcie_path.sh:
bash#!/bin/bash

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

TARGET_BDF="0f:00.0"

echo -e "${GREEN}=== PCIe Path Analysis for $TARGET_BDF ===${NC}"
echo ""

# 函数：获取设备的上游桥接
get_upstream_bridge() {
    local bdf=$1
    local bus=$(echo $bdf | cut -d: -f1)
    
    # 查找连接到这个总线的桥接
    lspci -nn | grep "\[0604\]" | while read line; do
        bridge_bdf=$(echo $line | awk '{print $1}')
        secondary=$(lspci -vvv -s $bridge_bdf 2>/dev/null | grep "Bus:" | grep -oP "secondary=\K[0-9a-f]+")
        
        if [ "$secondary" = "$bus" ]; then
            echo $bridge_bdf
            return
        fi
    done
}

# 获取完整路径
echo -e "${CYAN}Building PCIe path...${NC}"
PATH_LIST=()
CURRENT=$TARGET_BDF

while [ -n "$CURRENT" ]; do
    PATH_LIST=("$CURRENT" "${PATH_LIST[@]}")
    
    # 如果在 bus 00，停止
    if echo "$CURRENT" | grep -q "^00:"; then
        break
    fi
    
    # 查找上游
    UPSTREAM=$(get_upstream_bridge $CURRENT)
    if [ -z "$UPSTREAM" ]; then
        break
    fi
    CURRENT=$UPSTREAM
done

# 显示路径
echo ""
echo -e "${GREEN}=== Complete PCIe Hierarchy ===${NC}"
echo ""

LEVEL=0
for BDF in "${PATH_LIST[@]}"; do
    INDENT=$(printf '%*s' $((LEVEL * 4)) '')
    
    # 获取设备信息
    DEV_INFO=$(lspci -s $BDF)
    DEV_NAME=$(echo "$DEV_INFO" | cut -d: -f3- | xargs)
    
    # 检查是否是桥接
    IS_BRIDGE=$(echo "$DEV_INFO" | grep -i "bridge")
    
    if [ -n "$IS_BRIDGE" ]; then
        # 桥接设备 - 显示总线信息
        BUS_INFO=$(lspci -vvv -s $BDF 2>/dev/null | grep "Bus:" | head -1)
        PRI=$(echo "$BUS_INFO" | grep -oP "primary=\K[0-9a-f]+")
        SEC=$(echo "$BUS_INFO" | grep -oP "secondary=\K[0-9a-f]+")
        SUB=$(echo "$BUS_INFO" | grep -oP "subordinate=\K[0-9a-f]+")
        
        echo -e "${INDENT}${YELLOW}┌─ Level $LEVEL: $BDF${NC}"
        echo -e "${INDENT}${YELLOW}│  $DEV_NAME${NC}"
        echo -e "${INDENT}${YELLOW}│  Primary: $PRI, Secondary: $SEC, Subordinate: $SUB${NC}"
        
        # 链路状态
        LINK_INFO=$(lspci -vvv -s $BDF 2>/dev/null | grep "LnkSta:" | head -1)
        if [ -n "$LINK_INFO" ]; then
            SPEED=$(echo "$LINK_INFO" | grep -oP "Speed \K[0-9.]+GT/s")
            WIDTH=$(echo "$LINK_INFO" | grep -oP "Width x\K[0-9]+")
            echo -e "${INDENT}${YELLOW}│  Link: ${SPEED} x${WIDTH}${NC}"
        fi
        echo -e "${INDENT}${YELLOW}└─${NC}"
        echo -e "${INDENT}   ${BLUE}│${NC}"
    else
        # 终端设备
        echo -e "${INDENT}${GREEN}┌─ Level $LEVEL: $BDF (Endpoint)${NC}"
        echo -e "${INDENT}${GREEN}│  $DEV_NAME${NC}"
        
        # 链路状态
        LINK_INFO=$(lspci -vvv -s $BDF 2>/dev/null | grep "LnkSta:" | head -1)
        if [ -n "$LINK_INFO" ]; then
            SPEED=$(echo "$LINK_INFO" | grep -oP "Speed \K[0-9.]+GT/s")
            WIDTH=$(echo "$LINK_INFO" | grep -oP "Width x\K[0-9]+")
            echo -e "${INDENT}${GREEN}│  Link: ${SPEED} x${WIDTH}${NC}"
        fi
        echo -e "${INDENT}${GREEN}└─${NC}"
    fi
    
    LEVEL=$((LEVEL + 1))
    echo ""
done

# 显示地址解析
echo ""
echo -e "${CYAN}=== Address Format Explanation ===${NC}"
echo ""
echo "Target Device: $TARGET_BDF"
echo ""
echo "Full Address: 0000:$TARGET_BDF"
echo "              ││││ ││  └─ Function: 0"
echo "              ││││ └───── Device:   0"  
echo "              │└└└─────── Bus:      0f (decimal 15)"
echo "              └────────── Domain:   0000"
echo ""

# 路径摘要
echo -e "${GREEN}=== Path Summary ===${NC}"
echo ""
FIRST_BRIDGE=${PATH_LIST[0]}
LAST_DEVICE=${PATH_LIST[-1]}

echo "Root Complex Domain: 0000 (Domain 0)"
echo "Root Complex Bus:    00 (Bus 0)"
echo "Root Port:           $FIRST_BRIDGE"
echo "Target Device:       $LAST_DEVICE"
echo "Hops:                $((${#PATH_LIST[@]} - 1))"
echo ""

# 显示完整 BDF 路径
echo -e "${BLUE}Complete BDF Path:${NC}"
for i in "${!PATH_LIST[@]}"; do
    if [ $i -eq 0 ]; then
        echo -n "0000:${PATH_LIST[$i]}"
    else
        echo -n " → 0000:${PATH_LIST[$i]}"
    fi
done
echo ""
运行脚本：
bashchmod +x analyze_pcie_path.sh
./analyze_pcie_path.sh
```

---

## 总结

### `0000:00` 的含义

- **`0000`**: PCIe Domain 0（域 0）
- **`00`**: Bus 0（总线 0，Root Complex 主总线）
- 这是整个 PCIe 树的根节点

### `0f:00.0` 的完整路径
```
0000:00:1e.0 (Root Port, Bus 0)
    ↓
0000:0d:01.0 (PCIe Switch, Bus 13)
    ↓
0000:0f:00.0 (加速卡, Bus 15)
关键点：

域始终是 0000（单域系统）
经过 2 级桥接（Root Port → Switch → Device）
总线号递增：00 → 0d → 0f

