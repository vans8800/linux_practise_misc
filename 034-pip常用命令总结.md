## 背景信息

```python
(torch_venv) loongson@loongson-pc ~/t/l/p/s/n/core> pwd
/home/loongson/torch_venv/lib/python3.10/site-packages/numpy/core
(torch_venv) loongson@loongson-pc ~/t/l/p/s/n/core> ls _multiarray_umath.cpython-310-loongarch64-linux-gnu.so
_multiarray_umath.cpython-310-loongarch64-linux-gnu.so*
(torch_venv) loongson@loongson-pc ~/t/l/p/s/n/core> python -c "import numpy" 2>&1 | grep -i _multiarray
    from numpy.core._multiarray_umath import (
ModuleNotFoundError: No module named 'numpy.core._multiarray_umath'
    from numpy.core._multiarray_umath import (
Original error was: No module named 'numpy.core._multiarray_umath'
(torch_venv) loongson@loongson-pc ~/t/l/p/s/n/core>
```

## 排查措施

### 尝试ctypes加载有问题的库

```bash
loongson@loongson-pc:~$ fish
Welcome to fish, the friendly interactive shell
loongson@loongson-pc ~> source torch_venv/bin/activate.fish
(torch_venv) loongson@loongson-pc ~> python -c "import ctypes; ctypes.CDLL('/home/loongson/torch_venv/lib/python3.10/site-packages/numpy/core/_multiarray_umath.cpython-310-loongarch64-linux-gnu.so')"
(torch_venv) loongson@loongson-pc ~> echo $status
0
```

动态库可以通过 ctypes 正常加载，说明库文件本身和依赖都没问题。问题出在 Python 的模块导入机制上。

### python的调试手段：

```bash
export PYTHONVERBOSE=1

or
python -vv -c "import numpy" 2>&1 | grep -i "multiarray" | head -20
```

```bash
(torch_venv) loongson@loongson-pc ~/torch_venv> python -vv -c "import numpy" 2>&1 | grep -i "multiarray" | head -20
# trying /home/loongson/torch_venv/lib/python3.10/site-packages/numpy/core/multiarray.cpython-310.so
# trying /home/loongson/torch_venv/lib/python3.10/site-packages/numpy/core/multiarray.abi3.so
# trying /home/loongson/torch_venv/lib/python3.10/site-packages/numpy/core/multiarray.so
# trying /home/loongson/torch_venv/lib/python3.10/site-packages/numpy/core/multiarray.py
# /home/loongson/torch_venv/lib/python3.10/site-packages/numpy/core/__pycache__/multiarray.cpython-310.pyc matches /home/loongson/torch_venv/lib/python3.10/site-packages/numpy/core/multiarray.py
# code object from '/home/loongson/torch_venv/lib/python3.10/site-packages/numpy/core/__pycache__/multiarray.cpython-310.pyc'
# trying /home/loongson/torch_venv/lib/python3.10/site-packages/numpy/core/_multiarray_umath.cpython-310.so
# trying /home/loongson/torch_venv/lib/python3.10/site-packages/numpy/core/_multiarray_umath.abi3.so
# trying /home/loongson/torch_venv/lib/python3.10/site-packages/numpy/core/_multiarray_umath.so
# trying /home/loongson/torch_venv/lib/python3.10/site-packages/numpy/core/_multiarray_umath.py
# trying /home/loongson/torch_venv/lib/python3.10/site-packages/numpy/core/_multiarray_umath.pyc
    from . import multiarray
  File "/home/loongson/torch_venv/lib/python3.10/site-packages/numpy/core/multiarray.py", line 10, in <module>
    from numpy.core._multiarray_umath import (
ModuleNotFoundError: No module named 'numpy.core._multiarray_umath'
    from numpy.core._multiarray_umath import (
Original error was: No module named 'numpy.core._multiarray_umath'
# destroy numpy.core.multiarray
(torch_venv) loongson@loongson-pc ~/torch_venv>
```

Python 在尝试导入 _multiarray_umath 时，搜索的是：
_multiarray_umath.cpython-310.so
_multiarray_umath.abi3.so
_multiarray_umath.so

但实际文件名是：
_multiarray_umath.cpython-310-loongarch64-linux-gnu.so
Python 无法识别带有平台后缀的 .so 文件名。


#### 解决方案

创建软连接
```bash
ln -f  _multiarray_umath.cpython-310-loongarch64-linux-gnu.so _multiarray_umath.so
```
# pip 命令速通手册

## 一、基础操作

### 1.1 安装与升级 pip
```bash
# 升级 pip 到最新版本
python -m pip install --upgrade pip

# 查看 pip 版本
pip --version
pip -V
```

### 1.2 安装包
```bash
# 基础安装
pip install package_name

# 安装指定版本
pip install package_name==1.2.3

# 安装版本范围
pip install 'package_name>=1.0,<2.0'

# 从 requirements.txt 批量安装
pip install -r requirements.txt

# 安装本地包
pip install /path/to/package.whl
pip install /path/to/package/

# 从 Git 仓库安装
pip install git+https://github.com/user/repo.git
pip install git+https://github.com/user/repo.git@branch_name
```

### 1.3 卸载包
```bash
# 卸载单个包
pip uninstall package_name

# 批量卸载（不询问确认）
pip uninstall -y package1 package2

# 卸载 requirements.txt 中的所有包
pip uninstall -r requirements.txt -y
```

## 二、包信息查询

### 2.1 列出已安装的包
```bash
# 列出所有已安装的包
pip list

# 列出过期的包
pip list --outdated
pip list -o

# 以 requirements 格式输出
pip freeze

# 保存到文件
pip freeze > requirements.txt

# 只显示非依赖包（用户手动安装的）
pip list --not-required
```

### 2.2 查看包详细信息
```bash
# 查看包的详细信息
pip show package_name

# 查看包的依赖关系
pip show package_name | grep Requires

# 查看包的安装位置
pip show package_name | grep Location

# 查看多个包
pip show package1 package2
```

### 2.3 搜索包（已弃用，建议用网站）
```bash
# 注意：pip search 已被 PyPI 禁用
# 建议直接访问 https://pypi.org/ 搜索

# 替代方案：使用第三方工具
pip install pip_search
pip_search keyword
```

## 三、依赖分析

### 3.1 检查依赖完整性
```bash
# 检查已安装包的依赖是否满足
pip check

# 检查特定包
pip check package_name
```

### 3.2 依赖树可视化
```bash
# 安装 pipdeptree 工具
pip install pipdeptree

# 显示依赖树
pipdeptree

# 只显示某个包的依赖
pipdeptree -p package_name

# 反向依赖（谁依赖这个包）
pipdeptree -r -p package_name

# 以 JSON 格式输出
pipdeptree --json
```

### 3.3 查找冲突
```bash
# 查看版本冲突
pip check

# 使用 pipdeptree 查找冲突
pipdeptree --warn fail
```

## 四、高级安装选项

### 4.1 编译和二进制选项
```bash
# 只使用二进制包（不编译）
pip install package_name --only-binary :all:

# 不使用二进制包（从源码编译）
pip install package_name --no-binary :all:

# 针对特定包禁用二进制
pip install package_name --no-binary package_name

# 强制重新安装
pip install package_name --force-reinstall

# 忽略已安装的包
pip install package_name --ignore-installed
```

### 4.2 缓存管理
```bash
# 查看缓存目录
pip cache dir

# 查看缓存信息
pip cache info

# 列出缓存的包
pip cache list

# 清除所有缓存
pip cache purge

# 清除特定包的缓存
pip cache remove package_name

# 禁用缓存安装
pip install package_name --no-cache-dir
```

### 4.3 下载但不安装
```bash
# 下载包到指定目录
pip download package_name -d /path/to/directory

# 下载 requirements.txt 中的所有包
pip download -r requirements.txt -d ./packages/

# 下载平台特定的包
pip download package_name --platform manylinux1_x86_64 --only-binary=:all:
```

## 五、虚拟环境相关

### 5.1 创建 requirements.txt
```bash
# 导出当前环境所有包
pip freeze > requirements.txt

# 只导出项目直接依赖（需要 pipreqs）
pip install pipreqs
pipreqs /path/to/project

# 导出特定包及其依赖
pip freeze | grep -i package_name
```

### 5.2 虚拟环境最佳实践
```bash
# 创建虚拟环境
python -m venv myenv

# 激活虚拟环境
source myenv/bin/activate  # Linux/Mac
myenv\Scripts\activate     # Windows

# 在虚拟环境中安装包
pip install -r requirements.txt

# 退出虚拟环境
deactivate
```

## 六、镜像源配置

### 6.1 临时使用镜像源
```bash
# 使用清华源
pip install package_name -i https://pypi.tuna.tsinghua.edu.cn/simple

# 使用阿里云源
pip install package_name -i https://mirrors.aliyun.com/pypi/simple/

# 使用豆瓣源
pip install package_name -i https://pypi.douban.com/simple/
```

### 6.2 永久配置镜像源
```bash
# Linux/Mac 配置文件位置：~/.pip/pip.conf
# Windows 配置文件位置：%HOMEPATH%\pip\pip.ini

# 配置清华源
pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple

# 查看配置
pip config list

# 查看配置文件路径
pip config list -v

# 取消配置
pip config unset global.index-url
```

**常用国内镜像源：**
- 清华：https://pypi.tuna.tsinghua.edu.cn/simple
- 阿里云：https://mirrors.aliyun.com/pypi/simple/
- 中科大：https://pypi.mirrors.ustc.edu.cn/simple/
- 豆瓣：https://pypi.douban.com/simple/

## 七、故障排查

### 7.1 查看详细安装日志
```bash
# 显示详细输出
pip install package_name -v

# 显示更详细的调试信息
pip install package_name -vv

# 显示最详细的调试信息
pip install package_name -vvv
```

### 7.2 测试包导入
```bash
# 测试包是否可以正常导入
python -c "import package_name; print(package_name.__version__)"

# 查看包的安装位置
python -c "import package_name; print(package_name.__file__)"

# 查看 Python 搜索路径
python -c "import sys; print('\n'.join(sys.path))"
```

```bash
(torch_venv) loongson@loongson-pc ~> python -c "import sys; print('\n'.join(sys.path))"
/usr/local/opencv/lib/python3.10/site-packages
/usr/local/python3.10.19/lib/python3.10/site-packages
/home/loongson
/usr/local/lib/python310.zip
/usr/local/lib/python3.10
/usr/local/lib/python3.10/lib-dynload
/home/loongson/torch_venv/lib/python3.10/site-packages
```

### 7.3 验证安装完整性
```bash
# 检查依赖
pip check

# 重新安装（不使用缓存）
pip install package_name --force-reinstall --no-cache-dir

# 验证已安装的文件
pip show -f package_name
```

### 7.4 处理架构特定问题
```bash
# 检查 Python 的扩展后缀
python -c "import sysconfig; print(sysconfig.get_config_var('EXT_SUFFIX'))"

# 检查平台信息
python -c "import platform; print(platform.machine())"

# 列出包的所有文件（包括 .so 文件）
pip show -f package_name | grep "\.so"
```

## 八、实用工具命令

### 8.1 批量操作
```bash
# 升级所有过期的包（Linux/Mac）
pip list --outdated --format=freeze | cut -d = -f 1 | xargs -n1 pip install -U

# 升级所有过期的包（Windows PowerShell）
pip list --outdated --format=freeze | %{$_.split('==')[0]} | %{pip install --upgrade $_}

# 卸载所有包（慎用！）
pip freeze | xargs pip uninstall -y
```

### 8.2 导出与导入环境
```bash
# 导出完整环境（包含版本和哈希）
pip freeze > requirements.txt

# 导入环境
pip install -r requirements.txt

# 导出精简版（只包含直接依赖）
# 需要手动筛选或使用 pipreqs
```

### 8.3 安全检查
```bash
# 安装 safety 工具
pip install safety

# 检查已知安全漏洞
safety check

# 检查 requirements.txt
safety check -r requirements.txt
```

## 九、常见问题解决

### 9.1 权限问题
```bash
# 用户级安装（不需要 sudo）
pip install package_name --user

# 查看用户安装路径
python -m site --user-site
```

### 9.2 版本冲突
```bash
# 查看冲突
pip check

# 安装兼容版本
pip install 'package_name<2.0'

# 使用虚拟环境隔离
python -m venv clean_env
source clean_env/bin/activate
pip install package_name
```

### 9.3 网络问题
```bash
# 增加超时时间
pip install package_name --timeout 100

# 使用代理
pip install package_name --proxy http://proxy.example.com:8080

# 信任特定主机（不验证 SSL）
pip install package_name --trusted-host pypi.org --trusted-host files.pythonhosted.org
```

## 十、快速参考表

| 操作 | 命令 |
|------|------|
| 安装包 | `pip install package` |
| 卸载包 | `pip uninstall package` |
| 列出已安装 | `pip list` |
| 查看包信息 | `pip show package` |
| 检查依赖 | `pip check` |
| 导出环境 | `pip freeze > requirements.txt` |
| 导入环境 | `pip install -r requirements.txt` |
| 清除缓存 | `pip cache purge` |
| 升级 pip | `pip install --upgrade pip` |
| 搜索包 | 访问 https://pypi.org/ |

## 十一、进阶技巧

### 11.1 条件安装
```bash
# 根据 Python 版本条件安装
# 在 requirements.txt 中：
package_name>=1.0; python_version < '3.8'
package_name>=2.0; python_version >= '3.8'

# 根据操作系统条件安装
package_name; sys_platform == 'linux'
package_name; sys_platform == 'win32'
```

### 11.2 开发模式安装
```bash
# 以可编辑模式安装（开发时使用）
pip install -e /path/to/package

# 安装时包含开发依赖
pip install -e .[dev]
```

### 11.3 约束文件
```bash
# 使用约束文件锁定版本
pip install -r requirements.txt -c constraints.txt

# constraints.txt 示例：
# package1==1.0.0
# package2==2.0.0
```

---

**提示：** 本手册涵盖了 pip 的常用操作，更多详细信息请参考官方文档：https://pip.pypa.io/

## Pypi 和 trove classifiers
---

PyPI 和 Trove Classifiers 的关系可以类比为图书馆和图书分类系统的关系。让我详细解释：

### 一、基本概念

PyPI (Python Package Index)

是什么：Python 官方的软件包仓库，类似于一个大型图书馆
作用：存储、分发 Python 包，让开发者可以通过 pip install 安装包
地址：https://pypi.org/

Trove Classifiers
是什么：一套标准化的分类标签系统
作用：给 Python 包打标签，方便检索和筛选
类比：就像图书馆的分类号（文学、科学、历史等）

### 二、它们的关系

<img width="962" height="348" alt="image" src="https://github.com/user-attachments/assets/154ec9b6-8299-4cfd-8b1b-de9210b6e6d1" />


关系总结：
- PyPI 是容器/平台

- Trove Classifiers 是元数据/标签

- 每个上传到 PyPI 的包都**可以（也应该）**使用 Trove Classifiers 来描述自己

### 三、Trove Classifiers 的分类维度

3.1 主要分类类别

<img width="1005" height="620" alt="image" src="https://github.com/user-attachments/assets/1fe7926b-bd8a-4c6e-9757-cd64d85c9c99" />

3.2 实际例子

以 NumPy 为例，它的 Trove Classifiers：

<img width="897" height="461" alt="image" src="https://github.com/user-attachments/assets/636e7ba6-dee6-4aca-b580-2d889dbafb11" />


### 四、在实践中的应用

#### 4.1 在 setup.py 中定义

```python
pythonfrom setuptools import setup

setup(
    name='my-package',
    version='1.0.0',
    classifiers=[
        # 开发状态
        'Development Status :: 4 - Beta',
        
        # 目标用户
        'Intended Audience :: Developers',
        
        # 许可证
        'License :: OSI Approved :: MIT License',
        
        # Python 版本
        'Programming Language :: Python :: 3',
        'Programming Language :: Python :: 3.8',
        'Programming Language :: Python :: 3.9',
        'Programming Language :: Python :: 3.10',
        
        # 主题
        'Topic :: Software Development :: Libraries',
    ],
)
```

#### 4.2 在 pyproject.toml 中定义

```toml
[project]
name = "my-package"
version = "1.0.0"
classifiers = [
    "Development Status :: 4 - Beta",
    "Intended Audience :: Developers",
    "License :: OSI Approved :: MIT License",
    "Programming Language :: Python :: 3.8",
    "Programming Language :: Python :: 3.9",
    "Topic :: Software Development :: Libraries",
]
```

### 五、Trove Classifiers 的作用

#### 5.1 对用户的价值

- **快速筛选**：在 PyPI 上按条件搜索包
  - 示例：只找支持 Python 3.10 的包
  - 示例：只找 MIT 许可证的包
- **信息透明**：快速了解包的成熟度、兼容性

#### 5.2 对开发者的价值

- **提高可见性**：正确的标签让包更容易被发现
- **传达信息**：明确告知用户包的特性和限制
- **社区规范**：遵循标准化的描述方式

#### 5.3 在 PyPI 页面的展示

访问任何包的 PyPI 页面，例如：https://pypi.org/project/numpy/

你会看到左侧有 "Meta" 部分显示：

```
License: BSD
Author: NumPy Developers
Requires: Python >=3.8
Classifiers:
  - Development Status :: 5 - Production/Stable
  - Intended Audience :: Science/Research
  - License :: OSI Approved :: BSD License
  - Programming Language :: Python :: 3.8
  ...
```

### 六、查看所有可用的 Classifiers

#### 6.1 通过命令行查看

```bash
#查看所有官方的 Trove Classifiers
pip install trove-classifiers
python -c "from trove_classifiers import classifiers; print('\n'.join(classifiers))"
```

#### 6.2 在线查看

访问：https://pypi.org/classifiers/

### 七、常见误区

#### ❌ 错误理解

1. "Trove Classifiers 是 PyPI 的子系统"
   - **实际**：它们是独立的分类标准，PyPI 只是使用它们

2. "不加 Classifiers 包就无法上传"
   - **实际**：Classifiers 是可选的，但强烈建议添加

3. "Classifiers 会影响包的功能"
   - **实际**：它们只是元数据标签，不影响代码运行

#### ✅ 正确理解
- Trove Classifiers 是**描述性元数据**
- PyPI 是**使用这些元数据的平台**
- 它们共同提升了 Python 生态的**可发现性和组织性**

### 八、实际应用场景

#### 场景 1：用户搜索包


用户需求：找一个支持 Python 3.10 的 Web 框架

在 PyPI 搜索时可以筛选：
- Programming Language :: Python :: 3.10
- Topic :: Internet :: WWW/HTTP :: Dynamic Content
- Framework :: Django (或其他框架)

#### 场景 2：开发者发布包

```python

# setup.py
classifiers=[
    # 明确告诉用户：这是生产级稳定版本
    'Development Status :: 5 - Production/Stable',
    
    # 只支持 Python 3.8+
    'Programming Language :: Python :: 3.8',
    'Programming Language :: Python :: 3.9',
    'Programming Language :: Python :: 3.10',
    
    # MIT 许可证，可商用
    'License :: OSI Approved :: MIT License',
]
```

### 场景 3：CI/CD 自动检测

某些工具会读取 Classifiers 来：
- 自动运行正确版本的 Python 测试
- 检查许可证兼容性
- 验证包的成熟度

### 总结
```
┌─────────────────────────────────────┐
│         PyPI (仓库平台)              │
│  ┌──────────────────────────────┐  │
│  │  Package: numpy              │  │
│  │  Version: 1.26.4             │  │
│  │  ┌────────────────────────┐  │  │
│  │  │ Trove Classifiers:     │  │  │
│  │  │ - Python :: 3.10 ✓     │  │  │
│  │  │ - Topic :: Scientific  │  │  │
│  │  │ - License :: BSD       │  │  │
│  │  └────────────────────────┘  │  │
│  └──────────────────────────────┘  │
│                                     │
│  用户可以基于 Classifiers 筛选     │
└─────────────────────────────────────┘
本质：PyPI 是存储和分发的平台，Trove Classifiers 是标准化的分类标签系统，两者结合让 Python 包生态更加有序和易用。


