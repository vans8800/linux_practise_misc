## 背景信息

报文在经过iptables的链时，会匹配链中的规则，遇到匹配的规则时，就执行对应的动作，若链中的规则都无法匹配到当前报文，则使用链的默认策略（默认动作），链的默认策略通常设置为ACCEPT或者DROP。

当链的默认策略设置为ACCEPT时，若对应的链中没有配置任何规则，就表示接受所有的报文，若对应的链中存在规则，但是这些规则没有匹配到报文，报文还是会被接受。

当链的默认策略设置为DROP时，若对应的链中没有配置任何规则，就表示拒绝所有报文，若对应的链中存在规则，但是这些规则没有匹配到报文，报文还是会被拒绝。

当链的默认策略设置为ACCEPT时，按照道理来说，在链中配置规则时，对应的动作应该设置为DROP或者REJECT，为什么呢？

因为默认策略已经为ACCEPT，若我们在设置规则时，对应动作仍然为ACCEPT，那么所有报文都会被放行了，因为不管报文是否被规则匹配到都会被ACCEPT，就失去访问控制的意义。

- 当链的默认策略为ACCEPT时，链中的规则对应的动作应该为DROP或者REJECT，表示只有匹配到规则的报文才会被拒绝，没有被规则匹配到的报文都会被默认接受，这就是”黑名单”机制。

- 当链的默认策略为DROP时，链中的规则对应的动作应该为ACCEPT，表示只有匹配到规则的报文才会被放行，没有被规则匹配到的报文都会被默认拒绝，这就是”白名单”机制。

> 若使用白名单机制，就要把所有人都当做坏人，只放行好人。
>
> 若使用黑名单机制，就要把所有人都当成好人，只拒绝坏人。

白名单机制似乎更加安全一些，黑名单机制似乎更加灵活一些。

现在一个简单的白名单: 只放行被规则匹配到的报文，其他报文一律拒绝.


## 白名单机制

假设，要放行ssh远程连接相关的报文，也想要放行web服务相关的报文，那么，在INPUT链中添加如下规则。

<img width="666" height="45" alt="image" src="https://github.com/user-attachments/assets/8332165e-9a47-4e03-94e0-449cd1c86668" />

如上图，已经放行了特定的报文，只有上述两条规则匹配到的报文才会被放行，现在，只要将INPUT链的默认策略改为DROP，即可实现白名单机制。

示例如下。

<img width="990" height="245" alt="image" src="https://github.com/user-attachments/assets/03be1278-665f-40d4-b36a-55c6797a432a" />

上图中，将INPUT链的默认策略改为DROP，并且已经实现了所谓的白名单机制，即默认拒绝所有报文，只放行特定的报文。

若此时执行”iptables -F”操作，filter表中的所有链中的所有规则都会被清空，而INPUT链的默认策略为DROP，所有报文都会被拒绝，不止ssh远程请求会被拒绝，其他报文也会被拒绝.

<img width="472" height="102" alt="image" src="https://github.com/user-attachments/assets/1a4f2909-943b-4351-9af4-44ed67a2c449" />

如上图，在当前ssh远程工具中执行”iptables -F”命令后，由于INPUT链中已经不存在任何规则，故所有报文都被拒绝，包括当前的ssh远程连接。

这就是默认策略设置为DROP的缺点，在对应的链中没有设置任何规则时，使用默认策略为DROP是非常不明智的，因为管理员也会把自己拒之门外.

即使对应的链中存在放行规则，当不小心使用”iptables -F”清空规则时，放行规则被删除，则所有数据包都无法进入，这个时候就相当于给管理员挖了个坑.

若想要使用”白名单”的机制，最好将链的默认策略保持为”ACCEPT”，然后将”拒绝所有请求”这条规则放在链的尾部，将”放行规则”放在前面.

这样，既能实现”白名单”机制，又能保证在规则被清空时，管理员还有机会连接到主机，示例如下。

因为刚才的ssh连接已经被拒绝，所以，此时直接在控制台中设置iptables规则

<img width="357" height="39" alt="image" src="https://github.com/user-attachments/assets/d830c5cd-9ee6-4801-a9c2-258e8db71fc3" />

如上图，先将INPUT链的默认策略设置为ACCEPT

然后继续配置需要放行的报文的规则，当所有放行规则设置完成后，在INPUT链的尾部，设置一条拒绝所有请求的规则。

<img width="648" height="198" alt="image" src="https://github.com/user-attachments/assets/7e253648-f390-4bfb-8362-2d2887b8cb7a" />

将INPUT链的默认策略设置为了ACCEPT，同时又使用了白名单机制，因为若报文符合放行条件，则会被前面的放行规则匹配到，若报文不符合放行条件，则会被最后一条拒绝规则匹配到.

此刻，即使误操作，执行了”iptables -F”操作，也能保证管理员能够远程到主机上进行维护，因为默认策略仍然是ACCEPT。
